sudo: required
addons:
  apt:
    update: true
    packages:
    - docker-ce
services:
- docker
script:
- export DOCKER_CLI_EXPERIMENTAL=enabled
- source utils.sh
- alpine_arm_sha=$(get_manifest_sha "treehouses/alpine:latest" "arm")
- echo $alpine_arm_sha
- kolibri_arm_sha=$(get_manifest_sha "treehouses/kolibri:latest" "arm")
- echo $kolibri_arm_sha
- flag_arm=$(is_base "treehouses/alpine@"$alpine_arm_sha "treehouses/kolibri@"$kolibri_arm_sha)
- echo $flag_arm
- alpine_amd64_sha=$(get_manifest_sha "treehouses/alpine:latest" "amd64")
- echo $alpine_amd64_sha
- kolibri_amd64_sha=$(get_manifest_sha "treehouses/kolibri:latest" "amd64")
- echo $kolibri_amd64_sha
- flag_amd64=$(is_base "treehouses/alpine@"$alpine_amd64_sha "treehouses/kolibri@"$kolibri_amd64_sha)
- echo $flag_amd64
- alpine_arm64_sha=$(get_manifest_sha "treehouses/alpine:latest" "arm64")
- echo $alpine_arm64_sha
- kolibri_arm64_sha=$(get_manifest_sha "treehouses/kolibri:latest" "arm64")
- echo $kolibri_arm64_sha
- flag_arm64=$(is_base "treehouses/alpine@"$alpine_arm64_sha "treehouses/kolibri@"$kolibri_arm64_sha)
- echo $flag_arm64
- echo $DOCKERAPIKEY | docker login -u "sevenseas" --password-stdinf
- docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
- build_image "treehouses/alpine:latest" arm "treehouses/kolibri" $flag_arm
- build_image "treehouses/alpine:latest" amd64 "treehouses/kolibri" $flag_amd64
- build_image "treehouses/alpine:latest" arm64 "treehouses/kolibri" $flag_arm64
- flag=$(change $flag_arm $flag_arm64 $flag_amd64)
- flag="true"
- #echo $flag
before_deploy:
- deploy_image "treehouses/kolibri" arm
- deploy_image "treehouses/kolibri" amd64
- deploy_image "treehouses/kolibri" arm64
- tag1="latest"
- tag2=$(date +%Y%m%d%H%M)
- echo $tag2
- create_manifest treehouses/kolibri $tag1 $tag2 treehouses/kolibri-tags:amd64 treehouses/kolibri-tags:arm
  treehouses/kolibri-tags:arm64
- docker manifest inspect treehouses/kolibri:$tag1
- docker manifest inspect treehouses/kolibri:$tag2
deploy:
- provider: script
  script: docker manifest push treehouses/kolibri:$tag1; docker manifest push treehouses/kolibri:$tag2
  skip_cleanup: true
  on:
    all_branches: true
    condition: "$flag = true"
env:
  global:
  - secure: JIi2w0/00THAOWzu6XMWGqz7fahSwAFrH9zzJyhZ8+frj2zv+MbhmGb1pdmA4qtKLN5UOMHbNFbvZUYWHDE2bZxqWWIpgUTwJoh07bVp/lWIdLSOgN5+gvu3Rqd/Ebii0EZU/tUJ4bBrODZcZxFXrqBWfE3mp4AMjR89bDxprszIwOq1B9eTMpiLPZFiuCuem31ybAbEebJhBZYEnT6BMV6id9NZ0bt+mInbVBM5p8GrMsm5FSe+NUGN9tRvVm0p3kLCof3HfRsCUDCEl8C2MKIID6RIpmd/UtlHeMAV0A0vwkmrIBbfxrGwsa6wekusHr56dm1l8ouHzPrVPEtr6HL3Y4hpQ2ZHqDYOZSzsQngs+xACHsb2OFjy8WrIWaSnmVQFHiWy4uF2w2XPlcJTZfi0kJYB9KSCWf9oZdC428xsAwvM4/kz7J6zQ25nEeqa6mqh+iL8LOWBrW2rQlTRfgudpqmZxRSKOpipnTrr7YHOL2MfkZBjNvb/Nn24aHOi/2Ws6fhTmPiv0PWtlEMpov4b5ruh3e7yAVvBvNGIO2gi1nizCfnMSXdntwBr/zZwe+Z4BbSOVC/o8t9/r6+zs/KwOHWIdb2S8etFIAquEyTBLUalwcfzZ6rZeeuc6q+cTMDQA8L69XRoKjjTM7wgQ3nTEVB439GtB/MWwH6OsVU=
